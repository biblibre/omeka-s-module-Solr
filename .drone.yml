---
kind: pipeline
name: omeka:3.1.2 php:8.0 mariadb:10.6
services:
- environment:
    MYSQL_DATABASE: omeka_test
    MYSQL_ROOT_PASSWORD: root
  image: mariadb:10.6
  name: db
steps:
- commands:
  - cp -rT /usr/src/omeka-s ../..
  - git clone --depth 1 https://github.com/biblibre/omeka-s-module-Search.git ../Search
  - echo 'host = "db"\nuser = "root"\npassword = "root"\ndbname = "omeka_test"\n'
    > ../../application/test/config/database.ini
  - bash -c "cd ../.. && php /usr/local/libexec/wait-for-db.php"
  - ../../vendor/bin/phpunit
  - ../../node_modules/.bin/gulp test:module:cs
  image: git.biblibre.com/omeka-s/omeka-s-ci:3.1.2-php8.0
  name: test
  pull: always
type: docker
workspace:
  path: omeka-s/modules/Solr
---
kind: pipeline
name: omeka:3.2.3 php:8.0 mariadb:10.6
services:
- environment:
    MYSQL_DATABASE: omeka_test
    MYSQL_ROOT_PASSWORD: root
  image: mariadb:10.6
  name: db
steps:
- commands:
  - cp -rT /usr/src/omeka-s ../..
  - git clone --depth 1 https://github.com/biblibre/omeka-s-module-Search.git ../Search
  - echo 'host = "db"\nuser = "root"\npassword = "root"\ndbname = "omeka_test"\n'
    > ../../application/test/config/database.ini
  - bash -c "cd ../.. && php /usr/local/libexec/wait-for-db.php"
  - ../../vendor/bin/phpunit
  - ../../node_modules/.bin/gulp test:module:cs
  image: git.biblibre.com/omeka-s/omeka-s-ci:3.2.3-php8.0
  name: test
  pull: always
type: docker
workspace:
  path: omeka-s/modules/Solr
---
kind: pipeline
name: omeka:4.0.4 php:8.0 mariadb:10.6
services:
- environment:
    MYSQL_DATABASE: omeka_test
    MYSQL_ROOT_PASSWORD: root
  image: mariadb:10.6
  name: db
steps:
- commands:
  - cp -rT /usr/src/omeka-s ../..
  - git clone --depth 1 https://github.com/biblibre/omeka-s-module-Search.git ../Search
  - echo 'host = "db"\nuser = "root"\npassword = "root"\ndbname = "omeka_test"\n'
    > ../../application/test/config/database.ini
  - bash -c "cd ../.. && php /usr/local/libexec/wait-for-db.php"
  - ../../vendor/bin/phpunit
  - ../../node_modules/.bin/gulp test:module:cs
  image: git.biblibre.com/omeka-s/omeka-s-ci:4.0.4-php8.0
  name: test
  pull: always
type: docker
workspace:
  path: omeka-s/modules/Solr
---
kind: pipeline
name: omeka:4.0.4 php:8.1 mariadb:10.6
services:
- environment:
    MYSQL_DATABASE: omeka_test
    MYSQL_ROOT_PASSWORD: root
  image: mariadb:10.6
  name: db
steps:
- commands:
  - cp -rT /usr/src/omeka-s ../..
  - git clone --depth 1 https://github.com/biblibre/omeka-s-module-Search.git ../Search
  - echo 'host = "db"\nuser = "root"\npassword = "root"\ndbname = "omeka_test"\n'
    > ../../application/test/config/database.ini
  - bash -c "cd ../.. && php /usr/local/libexec/wait-for-db.php"
  - ../../vendor/bin/phpunit
  - ../../node_modules/.bin/gulp test:module:cs
  image: git.biblibre.com/omeka-s/omeka-s-ci:4.0.4-php8.1
  name: test
  pull: always
type: docker
workspace:
  path: omeka-s/modules/Solr
---
kind: pipeline
name: omeka:4.0.4 php:8.2 mariadb:10.6
services:
- environment:
    MYSQL_DATABASE: omeka_test
    MYSQL_ROOT_PASSWORD: root
  image: mariadb:10.6
  name: db
steps:
- commands:
  - cp -rT /usr/src/omeka-s ../..
  - git clone --depth 1 https://github.com/biblibre/omeka-s-module-Search.git ../Search
  - echo 'host = "db"\nuser = "root"\npassword = "root"\ndbname = "omeka_test"\n'
    > ../../application/test/config/database.ini
  - bash -c "cd ../.. && php /usr/local/libexec/wait-for-db.php"
  - ../../vendor/bin/phpunit
  - ../../node_modules/.bin/gulp test:module:cs
  image: git.biblibre.com/omeka-s/omeka-s-ci:4.0.4-php8.2
  name: test
  pull: always
type: docker
workspace:
  path: omeka-s/modules/Solr
---
kind: pipeline
name: omeka:4.1.1 php:8.0 mariadb:10.6
services:
- environment:
    MYSQL_DATABASE: omeka_test
    MYSQL_ROOT_PASSWORD: root
  image: mariadb:10.6
  name: db
steps:
- commands:
  - cp -rT /usr/src/omeka-s ../..
  - git clone --depth 1 https://github.com/biblibre/omeka-s-module-Search.git ../Search
  - echo 'host = "db"\nuser = "root"\npassword = "root"\ndbname = "omeka_test"\n'
    > ../../application/test/config/database.ini
  - bash -c "cd ../.. && php /usr/local/libexec/wait-for-db.php"
  - ../../vendor/bin/phpunit
  - ../../node_modules/.bin/gulp test:module:cs
  image: git.biblibre.com/omeka-s/omeka-s-ci:4.1.1-php8.0
  name: test
  pull: always
type: docker
workspace:
  path: omeka-s/modules/Solr
---
kind: pipeline
name: omeka:4.1.1 php:8.1 mariadb:10.6
services:
- environment:
    MYSQL_DATABASE: omeka_test
    MYSQL_ROOT_PASSWORD: root
  image: mariadb:10.6
  name: db
steps:
- commands:
  - cp -rT /usr/src/omeka-s ../..
  - git clone --depth 1 https://github.com/biblibre/omeka-s-module-Search.git ../Search
  - echo 'host = "db"\nuser = "root"\npassword = "root"\ndbname = "omeka_test"\n'
    > ../../application/test/config/database.ini
  - bash -c "cd ../.. && php /usr/local/libexec/wait-for-db.php"
  - ../../vendor/bin/phpunit
  - ../../node_modules/.bin/gulp test:module:cs
  image: git.biblibre.com/omeka-s/omeka-s-ci:4.1.1-php8.1
  name: test
  pull: always
type: docker
workspace:
  path: omeka-s/modules/Solr
---
kind: pipeline
name: omeka:4.1.1 php:8.2 mariadb:10.6
services:
- environment:
    MYSQL_DATABASE: omeka_test
    MYSQL_ROOT_PASSWORD: root
  image: mariadb:10.6
  name: db
steps:
- commands:
  - cp -rT /usr/src/omeka-s ../..
  - git clone --depth 1 https://github.com/biblibre/omeka-s-module-Search.git ../Search
  - echo 'host = "db"\nuser = "root"\npassword = "root"\ndbname = "omeka_test"\n'
    > ../../application/test/config/database.ini
  - bash -c "cd ../.. && php /usr/local/libexec/wait-for-db.php"
  - ../../vendor/bin/phpunit
  - ../../node_modules/.bin/gulp test:module:cs
  image: git.biblibre.com/omeka-s/omeka-s-ci:4.1.1-php8.2
  name: test
  pull: always
type: docker
workspace:
  path: omeka-s/modules/Solr
---
kind: pipeline
name: omeka:4.1.1 php:8.2 mariadb:10.5 cypress solr:9.6.1
services:
- environment:
    MYSQL_DATABASE: omeka_test
    MYSQL_ROOT_PASSWORD: root
  image: mariadb:10.5
  name: db
- name: omekas
  environment:
    MYSQL_USER: root
    MYSQL_PASSWORD: root
    MYSQL_DATABASE: omeka_test
    MYSQL_HOST: db
    OMEKA_MODULES: https://github.com/biblibre/omeka-s-module-Search
  image: giocomai/omeka-s-docker:v4.1.1
  commands:
  - wget -O solr.tgz 'https://www.apache.org/dyn/closer.lua/solr/solr/9.6.1/solr-9.6.1.tgz?action=download'
  - tar -xf solr.tgz
  - rm solr.tgz
  - mv solr-9.6.1 solr

  - mkdir -p ~/.config/systemd/user
  - |
    bash -c "cat > ~/.config/systemd/user/solr.service << 'EOF'
    [Unit]
    Description=Solr
    After=network.target

    [Service]
    Type=forking
    ExecStart=/home/omeka/solr/bin/solr start
    ExecStop=/home/omeka/solr/bin/solr stop
    Restart=on-failure

    [Install]
    WantedBy=default.target
    EOF"
  - systemctl --user daemon-reload
  - systemctl --user enable --now solr

  - git clone https://git.biblibre.com/omeka-s/default-solr-conf ~/solr/server/solr/configsets/biblibre/conf
  - ~/solr/bin/solr create_core -c default -d biblibre
steps:
- commands:
  - bash -c "npx cypress run"
  image: cypress/included
  name: cypress
workspace:
  path: /var/www/html/modules/Solr
---
kind: signature
hmac: e2427d86e045c3fcfd3a7a8022afe0921d0dbb114902468a25b329c273ad0bf6

...
